<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«è½¦ç¥¨é¢„è®¢ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            text-align: center;
            padding: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            margin: 20px 0;
            padding: 25px;
            border-radius: 10px;
            border-left: 5px solid #4CAF50;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5em;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }

        .btn.btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .btn.btn-secondary:hover {
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.4);
        }

        .train-list {
            margin-top: 20px;
        }

        .train-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin: 15px 0;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .train-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .train-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .train-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2196F3;
        }

        .train-route {
            color: #666;
            font-size: 1.1em;
        }

        .seat-types {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .seat-type {
            background: #f8f9fa;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-width: 140px;
        }

        .seat-type:hover {
            background: #4CAF50;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .seat-type-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .seat-price {
            color: #e91e63;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .seat-available {
            color: #666;
            font-size: 0.9em;
        }

        .result-area {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .result-area.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .result-area.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .orders-table th,
        .orders-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .orders-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .orders-table tr:hover {
            background: #f5f5f5;
        }

        .status-confirmed {
            color: #28a745;
            font-weight: bold;
        }

        .status-cancelled {
            color: #dc3545;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .seat-types {
                flex-direction: column;
            }
            
            .train-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš„ ç«è½¦ç¥¨é¢„è®¢ç³»ç»Ÿ</h1>
            <p>å¿«é€Ÿä¾¿æ·çš„åœ¨çº¿ç«è½¦ç¥¨é¢„è®¢æœåŠ¡</p>
        </div>
        
        <div class="content">
            <!-- æœç´¢è½¦æ¬¡ -->
            <div class="section">
                <h2>ğŸ” æœç´¢è½¦æ¬¡</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="passengerName">ä¹˜å®¢å§“å</label>
                        <input type="text" id="passengerName" placeholder="è¯·è¾“å…¥ä¹˜å®¢å§“å">
                    </div>
                    <div class="form-group">
                        <label for="passengerId">èº«ä»½è¯å·</label>
                        <input type="text" id="passengerId" placeholder="è¯·è¾“å…¥èº«ä»½è¯å·">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="fromStation">å‡ºå‘ç«™</label>
                        <select id="fromStation">
                            <option value="">è¯·é€‰æ‹©å‡ºå‘ç«™</option>
                            <option value="åŒ—äº¬">åŒ—äº¬</option>
                            <option value="å¤©æ´¥">å¤©æ´¥</option>
                            <option value="æµå—">æµå—</option>
                            <option value="å—äº¬">å—äº¬</option>
                            <option value="ä¸Šæµ·">ä¸Šæµ·</option>
                            <option value="å¹¿å·">å¹¿å·</option>
                            <option value="æ·±åœ³">æ·±åœ³</option>
                            <option value="è¥¿å®‰">è¥¿å®‰</option>
                            <option value="æˆéƒ½">æˆéƒ½</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="toStation">åˆ°è¾¾ç«™</label>
                        <select id="toStation">
                            <option value="">è¯·é€‰æ‹©åˆ°è¾¾ç«™</option>
                            <option value="åŒ—äº¬">åŒ—äº¬</option>
                            <option value="å¤©æ´¥">å¤©æ´¥</option>
                            <option value="æµå—">æµå—</option>
                            <option value="å—äº¬">å—äº¬</option>
                            <option value="ä¸Šæµ·">ä¸Šæµ·</option>
                            <option value="å¹¿å·">å¹¿å·</option>
                            <option value="æ·±åœ³">æ·±åœ³</option>
                            <option value="è¥¿å®‰">è¥¿å®‰</option>
                            <option value="æˆéƒ½">æˆéƒ½</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="travelDate">å‡ºå‘æ—¥æœŸ</label>
                        <input type="date" id="travelDate" min="2025-07-17" max="2025-07-30">
                    </div>
                </div>
                <button class="btn" onclick="searchTrains()">ğŸ” æœç´¢è½¦æ¬¡</button>
                
                <div id="searchResult" class="result-area"></div>
                <div id="trainList" class="train-list"></div>
            </div>

            <!-- æŸ¥è¯¢è®¢å• -->
            <div class="section">
                <h2>ğŸ“‹ æŸ¥è¯¢è®¢å•</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="queryPassengerName">ä¹˜å®¢å§“å</label>
                        <input type="text" id="queryPassengerName" placeholder="è¯·è¾“å…¥ä¹˜å®¢å§“å">
                    </div>
                    <div class="form-group">
                        <label for="queryPassengerId">èº«ä»½è¯å·</label>
                        <input type="text" id="queryPassengerId" placeholder="è¯·è¾“å…¥èº«ä»½è¯å·">
                    </div>
                </div>
                <button class="btn" onclick="queryOrders()">ğŸ“‹ æŸ¥è¯¢è®¢å•</button>
                <button class="btn btn-secondary" onclick="queryAllOrders()">æŸ¥è¯¢æ‰€æœ‰è®¢å•</button>
                
                <div id="orderResult" class="result-area"></div>
                <div id="orderList"></div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨å¤„ç†è¯·æ±‚...</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        
        // å·¥å…·å‡½æ•°
        function showLoading() {
            document.getElementById('loading').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }
        
        function showResult(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.className = `result-area ${isSuccess ? 'success' : 'error'}`;
            element.textContent = message;
        }
        
        function hideResult(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'none';
        }

        // æœç´¢è½¦æ¬¡
        async function searchTrains() {
            const passengerName = document.getElementById('passengerName').value;
            const passengerId = document.getElementById('passengerId').value;
            const fromStation = document.getElementById('fromStation').value;
            const toStation = document.getElementById('toStation').value;
            const travelDate = document.getElementById('travelDate').value;
            
            // è¾“å…¥éªŒè¯
            if (!passengerName || !passengerId || !fromStation || !toStation || !travelDate) {
                showResult('searchResult', 'è¯·å¡«å†™å®Œæ•´çš„æœç´¢ä¿¡æ¯', false);
                return;
            }
            
            if (fromStation === toStation) {
                showResult('searchResult', 'å‡ºå‘ç«™å’Œåˆ°è¾¾ç«™ä¸èƒ½ç›¸åŒ', false);
                return;
            }
            
            showLoading();
            hideResult('searchResult');
            document.getElementById('trainList').innerHTML = '';
            
            try {
                const response = await fetch(`${API_BASE}/search-bookable-trains`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        fromStation,
                        toStation,
                        date: travelDate
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.data.length === 0) {
                        showResult('searchResult', 'æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è½¦æ¬¡ï¼Œè¯·æ£€æŸ¥å‡ºå‘ç«™ã€åˆ°è¾¾ç«™å’Œæ—¥æœŸ', false);
                    } else {
                        showResult('searchResult', `æ‰¾åˆ° ${data.data.length} ä¸ªå¯é¢„è®¢è½¦æ¬¡`, true);
                        displayTrains(data.data);
                    }
                } else {
                    showResult('searchResult', `æœç´¢å¤±è´¥: ${data.message}`, false);
                }
            } catch (error) {
                showResult('searchResult', `æœç´¢é”™è¯¯: ${error.message}`, false);
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºè½¦æ¬¡åˆ—è¡¨
        function displayTrains(trains) {
            const trainList = document.getElementById('trainList');
            let html = '';
            
            trains.forEach(train => {
                html += `
                    <div class="train-card">
                        <div class="train-header">
                            <div>
                                <div class="train-name">${train.name}</div>
                                <div class="train-route">${train.from} â†’ ${train.to}</div>
                            </div>
                            <div style="text-align: right; color: #666;">
                                <div>æ—¥æœŸ: ${train.date}</div>
                                <div>è½¦æ¬¡ID: ${train.id}</div>
                            </div>
                        </div>
                        <div class="seat-types">
                `;
                
                train.seatTypes.forEach(seatType => {
                    html += `
                        <div class="seat-type" onclick="bookTicket(${train.id}, '${seatType.type}', ${seatType.price}, '${train.name}', '${train.date}')">
                            <div class="seat-type-name">${seatType.type}</div>
                            <div class="seat-price">Â¥${seatType.price}</div>
                            <div class="seat-available">ä½™ç¥¨ ${seatType.availableSeats} å¼ </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            trainList.innerHTML = html;
        }

        // é¢„è®¢è½¦ç¥¨
        async function bookTicket(trainId, seatType, price, trainName, date) {
            const passengerName = document.getElementById('passengerName').value;
            const passengerId = document.getElementById('passengerId').value;
            const fromStation = document.getElementById('fromStation').value;
            const toStation = document.getElementById('toStation').value;
            const travelDate = document.getElementById('travelDate').value;
            
            if (!confirm(`ç¡®è®¤é¢„è®¢ä»¥ä¸‹è½¦ç¥¨ï¼Ÿ\n\nè½¦æ¬¡: ${trainName}\nåº§ä½ç±»å‹: ${seatType}\nä»·æ ¼: Â¥${price}\nä¹˜å®¢: ${passengerName}\nè¡Œç¨‹: ${fromStation} â†’ ${toStation}\næ—¥æœŸ: ${travelDate}`)) {
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`${API_BASE}/book`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        trainId: parseInt(trainId),
                        seatType,
                        passengerName,
                        passengerId,
                        fromStation,
                        toStation,
                        date: travelDate
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const booking = data.data;
                    const successMessage = `ğŸ‰ é¢„è®¢æˆåŠŸï¼\n\nè®¢å•å·: ${booking.orderId}\nè½¦æ¬¡: ${trainName}\nåº§ä½: ${booking.carriageNumber}è½¦å¢ ${booking.seatNumber}å·\nä¹˜å®¢: ${booking.passengerName}\nè¡Œç¨‹: ${booking.fromStation} â†’ ${booking.toStation}\næ—¥æœŸ: ${booking.date}\nä»·æ ¼: Â¥${booking.price}\nçŠ¶æ€: ${booking.status}`;
                    
                    alert(successMessage);
                    showResult('searchResult', 'é¢„è®¢æˆåŠŸï¼è®¢å•è¯¦æƒ…å·²å¼¹å‡ºæ˜¾ç¤ºã€‚', true);
                    
                    // é‡æ–°æœç´¢ä»¥æ›´æ–°ä½™ç¥¨ä¿¡æ¯
                    setTimeout(() => {
                        searchTrains();
                    }, 1000);
                } else {
                    showResult('searchResult', `é¢„è®¢å¤±è´¥: ${data.message}`, false);
                }
            } catch (error) {
                showResult('searchResult', `é¢„è®¢é”™è¯¯: ${error.message}`, false);
            } finally {
                hideLoading();
            }
        }

        // æŸ¥è¯¢è®¢å•
        async function queryOrders() {
            const passengerName = document.getElementById('queryPassengerName').value;
            const passengerId = document.getElementById('queryPassengerId').value;
            
            if (!passengerName || !passengerId) {
                showResult('orderResult', 'è¯·å¡«å†™ä¹˜å®¢å§“åå’Œèº«ä»½è¯å·', false);
                return;
            }
            
            showLoading();
            hideResult('orderResult');
            
            try {
                const url = `${API_BASE}/orders?passengerName=${encodeURIComponent(passengerName)}&passengerId=${encodeURIComponent(passengerId)}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    if (data.data.length === 0) {
                        showResult('orderResult', 'æœªæ‰¾åˆ°ç›¸å…³è®¢å•', false);
                        document.getElementById('orderList').innerHTML = '';
                    } else {
                        showResult('orderResult', `æ‰¾åˆ° ${data.data.length} ä¸ªè®¢å•`, true);
                        displayOrders(data.data);
                    }
                } else {
                    showResult('orderResult', `æŸ¥è¯¢å¤±è´¥: ${data.message}`, false);
                }
            } catch (error) {
                showResult('orderResult', `æŸ¥è¯¢é”™è¯¯: ${error.message}`, false);
            } finally {
                hideLoading();
            }
        }

        // æŸ¥è¯¢æ‰€æœ‰è®¢å•
        async function queryAllOrders() {
            showLoading();
            hideResult('orderResult');
            
            try {
                const response = await fetch(`${API_BASE}/orders`);
                const data = await response.json();
                
                if (data.success) {
                    showResult('orderResult', `æŸ¥è¯¢åˆ° ${data.data.length} ä¸ªè®¢å•`, true);
                    displayOrders(data.data);
                } else {
                    showResult('orderResult', `æŸ¥è¯¢å¤±è´¥: ${data.message}`, false);
                }
            } catch (error) {
                showResult('orderResult', `æŸ¥è¯¢é”™è¯¯: ${error.message}`, false);
            } finally {
                hideLoading();
            }
        }

        // æ˜¾ç¤ºè®¢å•åˆ—è¡¨
        function displayOrders(orders) {
            const orderList = document.getElementById('orderList');
            
            if (orders.length === 0) {
                orderList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">æš‚æ— è®¢å•æ•°æ®</p>';
                return;
            }
            
            let html = `
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>è®¢å•å·</th>
                            <th>è½¦æ¬¡</th>
                            <th>æ—¥æœŸ</th>
                            <th>è¡Œç¨‹</th>
                            <th>åº§ä½</th>
                            <th>ä¹˜å®¢</th>
                            <th>ä»·æ ¼</th>
                            <th>çŠ¶æ€</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            orders.forEach(order => {
                const statusClass = order.status === 'confirmed' ? 'status-confirmed' : 'status-cancelled';
                const seatInfo = order.carriageNumber && order.seatNumber ? 
                    `${order.carriageNumber}è½¦å¢ ${order.seatNumber}å·` : 'æœªåˆ†é…';
                
                html += `
                    <tr>
                        <td>${order.id}</td>
                        <td>${order.trainName || 'N/A'}</td>
                        <td>${order.date || 'N/A'}</td>
                        <td>${order.fromStation} â†’ ${order.toStation}</td>
                        <td>${seatInfo} (${order.seatType})</td>
                        <td>${order.passengerName}<br><small>${order.passengerId}</small></td>
                        <td>Â¥${order.price}</td>
                        <td><span class="${statusClass}">${order.status}</span></td>
                        <td>${new Date(order.createdAt).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            orderList.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date();
            const defaultDate = '2025-07-17'; // è®¾ç½®ä¸ºæµ‹è¯•æ•°æ®æ—¥æœŸ
            document.getElementById('travelDate').value = defaultDate;
            
            console.log('ç«è½¦ç¥¨é¢„è®¢ç³»ç»Ÿå·²åŠ è½½');
        };
    </script>
</body>
</html> 