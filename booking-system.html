<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁÅ´ËΩ¶Á•®È¢ÑËÆ¢Á≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            text-align: center;
            padding: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            margin: 20px 0;
            padding: 25px;
            border-radius: 10px;
            border-left: 5px solid #4CAF50;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5em;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }

        .btn.btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .btn.btn-secondary:hover {
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.4);
        }

        .train-list {
            margin-top: 20px;
        }

        .train-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin: 15px 0;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .train-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .train-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .train-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2196F3;
        }

        .train-route {
            color: #666;
            font-size: 1.1em;
        }

        .seat-types {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .seat-type {
            background: #f8f9fa;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-width: 140px;
        }

        .seat-type:hover {
            background: #4CAF50;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .seat-type-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .seat-price {
            color: #e91e63;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 5px;
        }

        .seat-available {
            color: #666;
            font-size: 0.9em;
        }

        .result-area {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .result-area.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .result-area.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .orders-table th,
        .orders-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .orders-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .orders-table tr:hover {
            background: #f5f5f5;
        }

        .status-confirmed {
            color: #28a745;
            font-weight: bold;
        }

        .status-cancelled {
            color: #dc3545;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .seat-types {
                flex-direction: column;
            }
            
            .train-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÑ ÁÅ´ËΩ¶Á•®È¢ÑËÆ¢Á≥ªÁªü</h1>
            <p>Âø´ÈÄü‰æøÊç∑ÁöÑÂú®Á∫øÁÅ´ËΩ¶Á•®È¢ÑËÆ¢ÊúçÂä°</p>
        </div>
        
        <div class="content">
            <!-- ÊêúÁ¥¢ËΩ¶Ê¨° -->
            <div class="section">
                <h2>üîç ÊêúÁ¥¢ËΩ¶Ê¨°</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="passengerName">‰πòÂÆ¢ÂßìÂêç</label>
                        <input type="text" id="passengerName" placeholder="ËØ∑ËæìÂÖ•‰πòÂÆ¢ÂßìÂêç">
                    </div>
                    <div class="form-group">
                        <label for="passengerId">Ë∫´‰ªΩËØÅÂè∑</label>
                        <input type="text" id="passengerId" placeholder="ËØ∑ËæìÂÖ•Ë∫´‰ªΩËØÅÂè∑">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="fromStation">Âá∫ÂèëÁ´ô</label>
                        <select id="fromStation">
                            <option value="">ËØ∑ÈÄâÊã©Âá∫ÂèëÁ´ô</option>
                            <option value="Âåó‰∫¨">Âåó‰∫¨</option>
                            <option value="Â§©Ê¥•">Â§©Ê¥•</option>
                            <option value="ÊµéÂçó">ÊµéÂçó</option>
                            <option value="Âçó‰∫¨">Âçó‰∫¨</option>
                            <option value="‰∏äÊµ∑">‰∏äÊµ∑</option>
                            <option value="ÂπøÂ∑û">ÂπøÂ∑û</option>
                            <option value="Ê∑±Âú≥">Ê∑±Âú≥</option>
                            <option value="Ë•øÂÆâ">Ë•øÂÆâ</option>
                            <option value="ÊàêÈÉΩ">ÊàêÈÉΩ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="toStation">Âà∞ËææÁ´ô</label>
                        <select id="toStation">
                            <option value="">ËØ∑ÈÄâÊã©Âà∞ËææÁ´ô</option>
                            <option value="Âåó‰∫¨">Âåó‰∫¨</option>
                            <option value="Â§©Ê¥•">Â§©Ê¥•</option>
                            <option value="ÊµéÂçó">ÊµéÂçó</option>
                            <option value="Âçó‰∫¨">Âçó‰∫¨</option>
                            <option value="‰∏äÊµ∑">‰∏äÊµ∑</option>
                            <option value="ÂπøÂ∑û">ÂπøÂ∑û</option>
                            <option value="Ê∑±Âú≥">Ê∑±Âú≥</option>
                            <option value="Ë•øÂÆâ">Ë•øÂÆâ</option>
                            <option value="ÊàêÈÉΩ">ÊàêÈÉΩ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="travelDate">Âá∫ÂèëÊó•Êúü</label>
                        <input type="date" id="travelDate" min="2025-07-17" max="2025-07-30">
                    </div>
                </div>
                <button class="btn" onclick="searchTrains()">üîç ÊêúÁ¥¢ËΩ¶Ê¨°</button>
                
                <div id="searchResult" class="result-area"></div>
                <div id="trainList" class="train-list"></div>
            </div>

            <!-- Êü•ËØ¢ËÆ¢Âçï -->
            <div class="section">
                <h2>üìã Êü•ËØ¢ËÆ¢Âçï</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="queryPassengerName">‰πòÂÆ¢ÂßìÂêç</label>
                        <input type="text" id="queryPassengerName" placeholder="ËØ∑ËæìÂÖ•‰πòÂÆ¢ÂßìÂêç">
                    </div>
                    <div class="form-group">
                        <label for="queryPassengerId">Ë∫´‰ªΩËØÅÂè∑</label>
                        <input type="text" id="queryPassengerId" placeholder="ËØ∑ËæìÂÖ•Ë∫´‰ªΩËØÅÂè∑">
                    </div>
                </div>
                <button class="btn" onclick="queryOrders()">üìã Êü•ËØ¢ËÆ¢Âçï</button>
                <button class="btn btn-secondary" onclick="queryAllOrders()">Êü•ËØ¢ÊâÄÊúâËÆ¢Âçï</button>
                
                <div id="orderResult" class="result-area"></div>
                <div id="orderList"></div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Ê≠£Âú®Â§ÑÁêÜËØ∑Ê±Ç...</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        
        // Â∑•ÂÖ∑ÂáΩÊï∞
        function showLoading() {
            document.getElementById('loading').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }
        
        function showResult(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.className = `result-area ${isSuccess ? 'success' : 'error'}`;
            element.textContent = message;
        }
        
        function hideResult(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'none';
        }

        // ÊêúÁ¥¢ËΩ¶Ê¨°
        async function searchTrains() {
            const passengerName = document.getElementById('passengerName').value;
            const passengerId = document.getElementById('passengerId').value;
            const fromStation = document.getElementById('fromStation').value;
            const toStation = document.getElementById('toStation').value;
            const travelDate = document.getElementById('travelDate').value;
            
            // ËæìÂÖ•È™åËØÅ
            if (!passengerName || !passengerId || !fromStation || !toStation || !travelDate) {
                showResult('searchResult', 'ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÊêúÁ¥¢‰ø°ÊÅØ', false);
                return;
            }
            
            if (fromStation === toStation) {
                showResult('searchResult', 'Âá∫ÂèëÁ´ôÂíåÂà∞ËææÁ´ô‰∏çËÉΩÁõ∏Âêå', false);
                return;
            }
            
            showLoading();
            hideResult('searchResult');
            document.getElementById('trainList').innerHTML = '';
            
            try {
                const response = await fetch(`${API_BASE}/search-bookable-trains`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        fromStation,
                        toStation,
                        date: travelDate
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.data.length === 0) {
                        showResult('searchResult', 'Êú™ÊâæÂà∞Á¨¶ÂêàÊù°‰ª∂ÁöÑËΩ¶Ê¨°ÔºåËØ∑Ê£ÄÊü•Âá∫ÂèëÁ´ô„ÄÅÂà∞ËææÁ´ôÂíåÊó•Êúü', false);
                    } else {
                        showResult('searchResult', `ÊâæÂà∞ ${data.data.length} ‰∏™ÂèØÈ¢ÑËÆ¢ËΩ¶Ê¨°`, true);
                        displayTrains(data.data);
                    }
                } else {
                    showResult('searchResult', `ÊêúÁ¥¢Â§±Ë¥•: ${data.message}`, false);
                }
            } catch (error) {
                showResult('searchResult', `ÊêúÁ¥¢ÈîôËØØ: ${error.message}`, false);
            } finally {
                hideLoading();
            }
        }

        // ÊòæÁ§∫ËΩ¶Ê¨°ÂàóË°®
        function displayTrains(trains) {
            const trainList = document.getElementById('trainList');
            let html = '';
            
            trains.forEach(train => {
                html += `
                    <div class="train-card">
                        <div class="train-header">
                            <div>
                                <div class="train-name">${train.name}</div>
                                <div class="train-route">${train.from} ‚Üí ${train.to}</div>
                            </div>
                            <div style="text-align: right; color: #666;">
                                <div>Êó•Êúü: ${train.date}</div>
                                <div>ËΩ¶Ê¨°ID: ${train.id}</div>
                            </div>
                        </div>
                        <div class="seat-types">
                `;
                
                train.seatTypes.forEach(seatType => {
                    html += `
                        <div class="seat-type" onclick="bookTicket(${train.id}, '${seatType.type}', ${seatType.price}, '${train.name}', '${train.date}')">
                            <div class="seat-type-name">${seatType.type}</div>
                            <div class="seat-price">¬•${seatType.price}</div>
                            <div class="seat-available">‰ΩôÁ•® ${seatType.availableSeats} Âº†</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            trainList.innerHTML = html;
        }

        // È¢ÑËÆ¢ËΩ¶Á•®
        async function bookTicket(trainId, seatType, price, trainName, date) {
            const passengerName = document.getElementById('passengerName').value;
            const passengerId = document.getElementById('passengerId').value;
            const fromStation = document.getElementById('fromStation').value;
            const toStation = document.getElementById('toStation').value;
            const travelDate = document.getElementById('travelDate').value;
            
            if (!confirm(`Á°ÆËÆ§È¢ÑËÆ¢‰ª•‰∏ãËΩ¶Á•®Ôºü\n\nËΩ¶Ê¨°: ${trainName}\nÂ∫ß‰ΩçÁ±ªÂûã: ${seatType}\n‰ª∑Ê†º: ¬•${price}\n‰πòÂÆ¢: ${passengerName}\nË°åÁ®ã: ${fromStation} ‚Üí ${toStation}\nÊó•Êúü: ${travelDate}`)) {
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch(`${API_BASE}/book`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        trainId: parseInt(trainId),
                        seatType,
                        passengerName,
                        passengerId,
                        fromStation,
                        toStation,
                        date: travelDate
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const booking = data.data;
                    const successMessage = `üéâ È¢ÑËÆ¢ÊàêÂäüÔºÅ\n\nËÆ¢ÂçïÂè∑: ${booking.orderId}\nËΩ¶Ê¨°: ${trainName}\nÂ∫ß‰Ωç: ${booking.carriageNumber}ËΩ¶Âé¢ ${booking.seatNumber}Âè∑\n‰πòÂÆ¢: ${booking.passengerName}\nË°åÁ®ã: ${booking.fromStation} ‚Üí ${booking.toStation}\nÊó•Êúü: ${booking.date}\n‰ª∑Ê†º: ¬•${booking.price}\nÁä∂ÊÄÅ: ${booking.status}`;
                    
                    alert(successMessage);
                    showResult('searchResult', 'È¢ÑËÆ¢ÊàêÂäüÔºÅËÆ¢ÂçïËØ¶ÊÉÖÂ∑≤ÂºπÂá∫ÊòæÁ§∫„ÄÇ', true);
                    
                    // ÈáçÊñ∞ÊêúÁ¥¢‰ª•Êõ¥Êñ∞‰ΩôÁ•®‰ø°ÊÅØ
                    setTimeout(() => {
                        searchTrains();
                    }, 1000);
                } else {
                    showResult('searchResult', `È¢ÑËÆ¢Â§±Ë¥•: ${data.message}`, false);
                }
            } catch (error) {
                showResult('searchResult', `È¢ÑËÆ¢ÈîôËØØ: ${error.message}`, false);
            } finally {
                hideLoading();
            }
        }

        // Êü•ËØ¢ËÆ¢Âçï
        async function queryOrders() {
            const passengerName = document.getElementById('queryPassengerName').value;
            const passengerId = document.getElementById('queryPassengerId').value;
            
            if (!passengerName || !passengerId) {
                showResult('orderResult', 'ËØ∑Â°´ÂÜô‰πòÂÆ¢ÂßìÂêçÂíåË∫´‰ªΩËØÅÂè∑', false);
                return;
            }
            
            showLoading();
            hideResult('orderResult');
            
            try {
                const url = `${API_BASE}/orders?passengerName=${encodeURIComponent(passengerName)}&passengerId=${encodeURIComponent(passengerId)}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    if (data.data.length === 0) {
                        showResult('orderResult', 'Êú™ÊâæÂà∞Áõ∏ÂÖ≥ËÆ¢Âçï', false);
                        document.getElementById('orderList').innerHTML = '';
                    } else {
                        showResult('orderResult', `ÊâæÂà∞ ${data.data.length} ‰∏™ËÆ¢Âçï`, true);
                        displayOrders(data.data);
                    }
                } else {
                    showResult('orderResult', `Êü•ËØ¢Â§±Ë¥•: ${data.message}`, false);
                }
            } catch (error) {
                showResult('orderResult', `Êü•ËØ¢ÈîôËØØ: ${error.message}`, false);
            } finally {
                hideLoading();
            }
        }

        // Êü•ËØ¢ÊâÄÊúâËÆ¢Âçï
        async function queryAllOrders() {
            showLoading();
            hideResult('orderResult');
            
            try {
                const response = await fetch(`${API_BASE}/orders`);
                const data = await response.json();
                
                if (data.success) {
                    showResult('orderResult', `Êü•ËØ¢Âà∞ ${data.data.length} ‰∏™ËÆ¢Âçï`, true);
                    displayOrders(data.data);
                } else {
                    showResult('orderResult', `Êü•ËØ¢Â§±Ë¥•: ${data.message}`, false);
                }
            } catch (error) {
                showResult('orderResult', `Êü•ËØ¢ÈîôËØØ: ${error.message}`, false);
            } finally {
                hideLoading();
            }
        }

        // ÊòæÁ§∫ËÆ¢ÂçïÂàóË°®
        function displayOrders(orders) {
            const orderList = document.getElementById('orderList');
            
            if (orders.length === 0) {
                orderList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">ÊöÇÊó†ËÆ¢ÂçïÊï∞ÊçÆ</p>';
                return;
            }
            
            let html = `
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>ËÆ¢ÂçïÂè∑</th>
                            <th>ËΩ¶Ê¨°</th>
                            <th>Êó•Êúü</th>
                            <th>Ë°åÁ®ã</th>
                            <th>Â∫ß‰Ωç</th>
                            <th>‰πòÂÆ¢</th>
                            <th>‰ª∑Ê†º</th>
                            <th>Áä∂ÊÄÅ</th>
                            <th>ÂàõÂª∫Êó∂Èó¥</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            orders.forEach(order => {
                const statusClass = order.status === 'confirmed' ? 'status-confirmed' : 'status-cancelled';
                const seatInfo = order.carriageNumber && order.seatNumber ? 
                    `${order.carriageNumber}ËΩ¶Âé¢ ${order.seatNumber}Âè∑` : 'Êú™ÂàÜÈÖç';
                
                html += `
                    <tr>
                        <td>${order.id}</td>
                        <td>${order.trainName || 'N/A'}</td>
                        <td>${order.date || 'N/A'}</td>
                        <td>${order.fromStation} ‚Üí ${order.toStation}</td>
                        <td>${seatInfo} (${order.seatType})</td>
                        <td>${order.passengerName}<br><small>${order.passengerId}</small></td>
                        <td>¬•${order.price}</td>
                        <td><span class="${statusClass}">${order.status}</span></td>
                        <td>${new Date(order.createdAt).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            orderList.innerHTML = html;
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        window.onload = function() {
            // ËÆæÁΩÆÈªòËÆ§Êó•Êúü‰∏∫‰ªäÂ§©
            const today = new Date();
            const defaultDate = '2025-07-17'; // ËÆæÁΩÆ‰∏∫ÊµãËØïÊï∞ÊçÆÊó•Êúü
            document.getElementById('travelDate').value = defaultDate;
            
            console.log('ÁÅ´ËΩ¶Á•®È¢ÑËÆ¢Á≥ªÁªüÂ∑≤Âä†ËΩΩ');
        };
    </script>
</body>
</html> 