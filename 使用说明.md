# 火车票售票系统 - MySQL版本使用说明

## 🚀 系统概述

本系统已成功配置为使用MySQL数据库，提供完整的火车票预订功能，包括：
- 火车信息查询
- 经停站价格查询
- 车票预订和余票管理
- 订单查询和管理
- 数据库事务支持

## 📦 文件结构

```
project/
├── back-end.js                    # 主服务器文件（MySQL版本）
├── package.json                   # 项目配置和依赖
├── mysql-test.html                # MySQL测试页面
├── mysql-quick-test.js            # MySQL快速测试脚本
├── start-mysql-server.bat         # Windows批处理启动脚本
├── start-mysql-server.ps1         # PowerShell启动脚本
├── MySQL测试指南.md               # 详细测试指南
├── 使用说明.md                   # 本文档
├── database-mysql-setup.js        # MySQL数据库设置脚本
├── database-dao.js                # 数据访问对象
├── database-mongodb.js            # MongoDB版本（备选）
├── database-sqlite.js             # SQLite版本（备选）
└── 数据库方案选择指南.md          # 数据库选择指南
```

## ⚙️ 环境要求

### 必需软件
1. **Node.js** (v14或更高版本)
2. **npm** (随Node.js安装)
3. **MySQL Server** (v8.0或更高版本)

### 依赖包
- `express` - Web框架
- `body-parser` - 请求体解析
- `mysql2` - MySQL数据库驱动

## 🔧 安装步骤

### 1. 安装MySQL服务器

#### Windows:
1. 下载MySQL Community Server: https://dev.mysql.com/downloads/mysql/
2. 运行安装程序，选择"Server only"
3. 设置root用户密码（建议设为空以匹配默认配置）
4. 启动MySQL服务：
   ```cmd
   net start mysql
   ```

#### 验证安装:
```cmd
mysql -u root -p
```

### 2. 准备Node.js环境

已配置的package.json包含所有必需依赖：
```json
{
  "dependencies": {
    "express": "^4.18.2",
    "body-parser": "^1.20.2",
    "mysql2": "^3.6.0"
  }
}
```

## 🚀 快速启动

### 方法1: 使用批处理文件（推荐）
```cmd
start-mysql-server.bat
```

### 方法2: 使用PowerShell脚本
```powershell
.\start-mysql-server.ps1
```

### 方法3: 手动启动
```cmd
npm install
node back-end.js
```

## 🧪 测试验证

### 1. 快速数据库测试
```cmd
node mysql-quick-test.js
```

此脚本会执行：
- ✅ 数据库连接测试
- ✅ 数据库和表结构创建
- ✅ 测试数据插入
- ✅ 查询功能测试
- ✅ 插入删除测试
- ✅ 事务处理测试

### 2. Web界面测试
启动服务器后，访问：
- **主测试页面**: http://localhost:3000/mysql-test.html
- **数据库连接测试**: http://localhost:3000/test-db

### 3. API接口测试

#### 查询火车信息
```http
GET http://localhost:3000/trains
GET http://localhost:3000/trains?from=北京&to=上海
```

#### 查询经停站信息
```http
GET http://localhost:3000/stops/1
```

#### 预订车票
```http
POST http://localhost:3000/book
Content-Type: application/json

{
  "trainId": 1,
  "seatType": "二等座",
  "passengerName": "张三",
  "passengerId": "123456789012345678",
  "fromStation": "北京",
  "toStation": "上海"
}
```

#### 查询订单
```http
GET http://localhost:3000/orders?passengerName=张三
```

## 📊 数据库结构

### 核心表结构

#### trains 表
```sql
CREATE TABLE trains (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(10) NOT NULL,
    from_station VARCHAR(50) NOT NULL,
    to_station VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### seat_types 表
```sql
CREATE TABLE seat_types (
    id INT AUTO_INCREMENT PRIMARY KEY,
    train_id INT NOT NULL,
    type VARCHAR(20) NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    available_seats INT NOT NULL,
    total_seats INT NOT NULL,
    FOREIGN KEY (train_id) REFERENCES trains(id)
);
```

#### stops 表
```sql
CREATE TABLE stops (
    id INT AUTO_INCREMENT PRIMARY KEY,
    train_id INT NOT NULL,
    station VARCHAR(50) NOT NULL,
    seat_type VARCHAR(20) NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (train_id) REFERENCES trains(id)
);
```

#### orders 表
```sql
CREATE TABLE orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    train_id INT NOT NULL,
    from_station VARCHAR(50) NOT NULL,
    to_station VARCHAR(50) NOT NULL,
    seat_type VARCHAR(20) NOT NULL,
    passenger_name VARCHAR(100) NOT NULL,
    passenger_id VARCHAR(20) NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (train_id) REFERENCES trains(id)
);
```

## 🔍 测试数据

系统自动创建以下测试数据：

### 火车信息
- G101: 北京 → 上海
- G102: 上海 → 北京  
- D201: 广州 → 深圳

### 座位类型
- 二等座: ¥500 (80张)
- 一等座: ¥800 (20张)
- 商务座: ¥1500 (10张)

### 经停站价格
- 天津: 二等座¥100, 一等座¥160
- 济南: 二等座¥200, 一等座¥320
- 南京: 二等座¥350, 一等座¥560

## 🎯 测试功能

### 1. 数据库连接测试
- 验证MySQL连接状态
- 检查数据库和表结构
- 显示连接池信息

### 2. 查询功能测试
- 查询所有火车信息
- 按出发站和到达站筛选
- 查询经停站价格信息

### 3. 预订功能测试
- 模拟车票预订流程
- 余票自动扣减
- 价格自动计算（含经停站）

### 4. 订单管理测试
- 按乘客姓名查询订单
- 按身份证号查询订单
- 订单详情显示

### 5. 事务处理测试
- 预订车票事务
- 余票更新事务
- 错误回滚测试

### 6. 压力测试
- 并发请求测试
- 数据库连接池测试
- 性能指标统计

## 🔧 配置说明

### 数据库连接配置
在`back-end.js`中修改：
```javascript
const dbConfig = {
    host: 'localhost',        // 数据库主机
    user: 'root',            // 用户名
    password: '',            // 密码
    database: 'train_ticket_system'  // 数据库名
};
```

### 服务器配置
```javascript
const PORT = process.env.PORT || 3000;  // 服务器端口
```

## 🚨 故障排除

### 常见问题及解决方案

#### 1. 数据库连接失败
```
Error: Access denied for user 'root'@'localhost'
```
**解决方案:**
- 检查MySQL服务是否启动: `net start mysql`
- 验证用户名和密码配置
- 重置root密码

#### 2. 端口3000被占用
```
Error: listen EADDRINUSE: address already in use :::3000
```
**解决方案:**
- 使用启动脚本会自动处理
- 手动停止进程: `taskkill /f /im node.exe`

#### 3. 依赖安装失败
```
npm ERR! network request failed
```
**解决方案:**
- 检查网络连接
- 清理npm缓存: `npm cache clean --force`
- 使用淘宝镜像: `npm config set registry https://registry.npm.taobao.org`

#### 4. MySQL服务未启动
```
Error: connect ECONNREFUSED 127.0.0.1:3306
```
**解决方案:**
- 启动MySQL服务: `net start mysql`
- 检查MySQL安装
- 确认端口3306是否开放

## 📈 性能优化

### 数据库优化
1. 添加索引：
   ```sql
   CREATE INDEX idx_train_route ON trains(from_station, to_station);
   CREATE INDEX idx_order_passenger ON orders(passenger_name, passenger_id);
   ```

2. 连接池配置：
   ```javascript
   const dbConfig = {
       // ...
       connectionLimit: 10,     // 连接池大小
       queueLimit: 0           // 队列限制
   };
   ```

### 应用优化
1. 启用gzip压缩
2. 实施查询缓存
3. 添加日志记录
4. 实施错误监控

## 🚀 生产部署

### 环境配置
1. **数据库配置**
   - 使用独立的MySQL服务器
   - 配置主从复制
   - 设置定期备份

2. **安全配置**
   - 修改默认密码
   - 限制数据库访问权限
   - 启用SSL连接

3. **监控配置**
   - 添加性能监控
   - 设置告警机制
   - 记录详细日志

### 扩展功能
1. 用户认证和授权
2. 支付系统集成
3. 消息队列支持
4. 缓存系统（Redis）
5. 负载均衡

## 📋 测试清单

### 功能测试
- [ ] 数据库连接测试
- [ ] 火车信息查询
- [ ] 经停站价格查询
- [ ] 车票预订流程
- [ ] 订单查询功能
- [ ] 事务处理测试

### 性能测试
- [ ] 并发请求处理
- [ ] 数据库连接池
- [ ] 响应时间测试
- [ ] 内存使用监控

### 稳定性测试
- [ ] 长时间运行测试
- [ ] 异常处理测试
- [ ] 资源释放测试
- [ ] 错误恢复测试

## 📞 技术支持

如果遇到问题，请：
1. 检查控制台错误信息
2. 查看MySQL错误日志
3. 运行快速测试脚本诊断
4. 参考故障排除指南

---

🎉 **恭喜！您已成功配置MySQL版本的火车票售票系统！**

现在可以开始使用和测试各项功能了。系统支持完整的CRUD操作、事务处理和并发控制，适合学习和开发使用。 